<!DOCTYPE html>
<html lang="sr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Zakazivanje Slikanja</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #eef1f5;
      margin: 0;
      padding: 20px;
    }
    h1 {
      text-align: center;
      color: #333;
    }
    .selector {
      text-align: center;
      margin-bottom: 15px;
    }
    #pretragaSifre {
      width: 200px;
      padding: 8px;
      font-size: 14px;
      border-radius: 6px;
      border: 1px solid #ccc;
      margin-bottom: 15px;
      text-align: center;
      display: block;
      margin-left: auto;
      margin-right: auto;
    }
    .day {
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      padding: 15px;
      max-width: 1200px;
      margin: 0 auto;
    }
    .day h2 {
      text-align: center;
      color: #444;
      margin-bottom: 20px;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 15px;
    }
    .time-slot {
      border: 1px solid #ccc;
      padding: 10px;
      border-radius: 6px;
      background: #f9f9f9;
      transition: background 0.3s ease;
      position: relative;
    }
    .time-slot.filled {
      background: #d0f0d0;
      opacity: 0.9;
    }
    .time-slot h4 {
      margin: 0 0 5px 0;
      font-size: 14px;
      color: #222;
      text-align: center;
    }
    .time-slot input[type="text"],
    .time-slot input[type="tel"] {
      width: 100%;
      padding: 5px;
      margin-bottom: 5px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 13px;
      text-align: center;
      box-sizing: border-box;
    }
    .slikano-label {
      display: block;
      font-size: 13px;
      margin: 5px 0;
      color: #333;
    }
    .slikano-label input {
      margin-right: 5px;
    }
    button.save-btn {
      margin-top: 5px;
      width: 100%;
      padding: 6px;
      border: none;
      border-radius: 4px;
      background-color: #1a73e8;
      color: #fff;
      font-size: 13px;
      cursor: pointer;
      transition: background 0.3s;
    }
    #rezultatiPretrage {
      text-align: center;
      margin-bottom: 10px;
      color: #555;
      font-weight: 600;
      white-space: pre-line;
    }
  </style>
</head>
<body>
  <h1>Zakazivanje Slikanja</h1>

  <input type="text" id="pretragaSifre" placeholder="Pretraga po šifri stana" oninput="pretraziSifru()" />

  <div class="selector">
    <label for="izborDatuma">Izaberi datum:</label>
    <select id="izborDatuma" onchange="promeniDatum(this.value)"></select>
  </div>

  <div id="rezultatiPretrage"></div>

  <div class="day" id="daySchedule">
    <h2>Učitavanje...</h2>
  </div>

  <script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzZiVfxttTAqr6lJFYzdma4kIa0K3HZanVYFFUxWFWLBdN00JbUzi9S4OtwUZ_eZ-yblQ/exec"; // <- OBAVEZNO ZAMENI

    const startHour = 9;
    const endHour = 19;
    const interval = 30;

    let savedData = {};
    let datumKey = getTodayInSerbia();

    function getTodayInSerbia() {
      const now = new Date();
      const offset = 2 * 60;
      const local = new Date(now.getTime() + (now.getTimezoneOffset() + offset) * 60000);
      return local.toISOString().split('T')[0];
    }

    async function fetchData(dateStr) {
      try {
        const response = await fetch(`${SCRIPT_URL}?action=getByDate&datum=${dateStr}`);
        const data = await response.json();
        savedData[dateStr] = {};
        data.forEach(item => {
          savedData[dateStr][item.Termin] = {
            sifra: item.SifraStana,
            agent: item.Agent,
            adresa: item.Adresa,
            telefon: item.Telefon,
            slikano: item.Slikano
          };
        });
        renderSchedule(dateStr);
        popuniDropdown();
      } catch (e) {
        document.getElementById("daySchedule").innerHTML = "<h2>Greška pri učitavanju podataka</h2>";
      }
    }

    async function saveSlot(dateStr, timeStr, slotData) {
      const params = new URLSearchParams({
        action: "update",
        datum: dateStr,
        termin: timeStr,
        sifraStana: slotData.sifra || '',
        agent: slotData.agent || '',
        adresa: slotData.adresa || '',
        telefon: slotData.telefon || '',
        slikano: slotData.slikano ? 'true' : 'false'
      });

      const response = await fetch(`${SCRIPT_URL}?${params.toString()}`);
      return await response.json();
    }

    function renderSchedule(dateStr) {
      const container = document.getElementById("daySchedule");
      container.innerHTML = "";

      const title = document.createElement("h2");
      title.textContent = `Datum: ${dateStr.split("-").reverse().join(".")}`;
      container.appendChild(title);

      const grid = document.createElement("div");
      grid.className = "grid";

      for (let h = startHour; h <= endHour; h++) {
        for (let m = 0; m < 60; m += interval) {
          const timeStr = `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
          const slotData = savedData[dateStr]?.[timeStr] || {
            agent: "", adresa: "", telefon: "", sifra: "", slikano: false
          };

          const slotDiv = document.createElement("div");
          slotDiv.className = "time-slot";
          if (slotData.agent || slotData.adresa || slotData.telefon || slotData.sifra) {
            slotDiv.classList.add("filled");
          }

          slotDiv.innerHTML = `
            <h4>${timeStr}</h4>
            <input type="text" placeholder="Agent" value="${slotData.agent}" class="agent" />
            <input type="text" placeholder="Adresa stana" value="${slotData.adresa}" class="adresa" />
            <input type="tel" placeholder="Kontakt telefon" value="${slotData.telefon}" class="telefon" />
            <input type="text" placeholder="Šifra stana" value="${slotData.sifra}" class="sifra" />
            <label class="slikano-label"><input type="checkbox" class="slikano" ${slotData.slikano ? 'checked' : ''}/> Slikano</label>
            <button class="save-btn">Sačuvaj</button>
          `;

          slotDiv.querySelector(".save-btn").onclick = async () => {
            const novaVrednost = {
              agent: slotDiv.querySelector(".agent").value,
              adresa: slotDiv.querySelector(".adresa").value,
              telefon: slotDiv.querySelector(".telefon").value,
              sifra: slotDiv.querySelector(".sifra").value,
              slikano: slotDiv.querySelector(".slikano").checked
            };

            const btn = slotDiv.querySelector(".save-btn");
            btn.textContent = "Čuvanje...";
            btn.disabled = true;

            await saveSlot(dateStr, timeStr, novaVrednost);
            slotDiv.classList.add("filled");
            btn.textContent = "Sačuvano ✔";
            btn.style.background = "#34a853";
            setTimeout(() => {
              btn.textContent = "Sačuvaj";
              btn.disabled = false;
              btn.style.background = "#1a73e8";
            }, 1500);
          };

          grid.appendChild(slotDiv);
        }
      }
      container.appendChild(grid);
    }

    function popuniDropdown() {
      const select = document.getElementById("izborDatuma");
      select.innerHTML = "";
      const datumi = Object.keys(savedData);
      if (!datumi.includes(datumKey)) datumi.push(datumKey);
      datumi.sort();
      datumi.forEach(datum => {
        const option = document.createElement("option");
        option.value = datum;
        option.textContent = datum.split("-").reverse().join(".");
        if (datum === datumKey) option.selected = true;
        select.appendChild(option);
      });
    }

    function promeniDatum(datum) {
      datumKey = datum;
      if (savedData[datum]) {
        renderSchedule(datum);
      } else {
        fetchData(datum);
      }
      document.getElementById("pretragaSifre").value = "";
      document.getElementById("rezultatiPretrage").textContent = "";
    }

    function pretraziSifru() {
      const query = document.getElementById("pretragaSifre").value.trim().toLowerCase();
      const rezDiv = document.getElementById("rezultatiPretrage");
      if (!query) {
        rezDiv.textContent = "";
        return;
      }

      let results = [];
      let firstFoundId = null;
      let firstFoundDate = null;

      Object.entries(savedData).forEach(([datum, termini]) => {
        Object.entries(termini).forEach(([vreme, podaci]) => {
          if (podaci.sifra && podaci.sifra.toLowerCase().includes(query)) {
            results.push(`- ${datum.split("-").reverse().join(".")} u ${vreme} | Šifra: ${podaci.sifra}`);
            if (!firstFoundDate) {
              firstFoundDate = datum;
            }
          }
        });
      });

      if (results.length) {
        rezDiv.textContent = `Pronađeno ${results.length} termin(a):\n` + results.join("\n");
        if (firstFoundDate !== datumKey) {
          datumKey = firstFoundDate;
          document.getElementById("izborDatuma").value = firstFoundDate;
          renderSchedule(firstFoundDate);
        }
      } else {
        rezDiv.textContent = "Nema rezultata za ovu šifru.";
      }
    }

    fetchData(datumKey);
  </script>
</body>
</html>
