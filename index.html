<!DOCTYPE html>
<html lang="sr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Zakazivanje Slikanja</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #eef1f5;
      margin: 0;
      padding: 20px;
    }
    h1 {
      text-align: center;
      color: #333;
    }
    #datePicker {
      display: block;
      margin: 10px auto 20px auto;
      font-size: 16px;
      padding: 5px;
      max-width: 150px;
    }
    #slotsContainer {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
    }
    .slotCard {
      background: white;
      border-radius: 8px;
      box-shadow: 0 0 6px rgba(0,0,0,0.1);
      padding: 15px;
      width: 220px;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .slotCard.filled {
      background: #d0f0d0;
    }
    .slotCard label {
      font-weight: bold;
      font-size: 14px;
    }
    .slotCard input[type="text"],
    .slotCard input[type="tel"] {
      padding: 5px;
      font-size: 13px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    .slotCard input[type="checkbox"] {
      margin-left: 5px;
    }
    .slotCard button {
      margin-top: 10px;
      padding: 7px;
      background: #2d8fdd;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
    }
    .slotCard button:hover {
      background: #1b6fbb;
    }
  </style>
</head>
<body>
  <h1>Zakazivanje Slikanja</h1>
  <input type="date" id="datePicker" />
  <div id="slotsContainer"></div>

<script>
  const apiBase = 'https://sheetdb.io/api/v1/ywvbhlm9ikdui';
  const startHour = 9;
  const endHour = 19;
  const intervalMinutes = 30;

  // Dobij danasnji datum po vremenskoj zoni Srbije
  function getTodaySerbiaDate() {
    const now = new Date();
    try {
      const options = { timeZone: 'Europe/Belgrade', year: 'numeric', month: '2-digit', day: '2-digit' };
      const formatter = new Intl.DateTimeFormat('sv-SE', options); // yyyy-MM-dd format
      const parts = formatter.formatToParts(now);
      let yyyy, mm, dd;
      parts.forEach(({type, value}) => {
        if(type === 'year') yyyy = value;
        else if(type === 'month') mm = value;
        else if(type === 'day') dd = value;
      });
      return `${yyyy}-${mm}-${dd}`;
    } catch(e) {
      // fallback: UTC + 2h approx
      const utc = new Date(now.toLocaleString('en-US', {timeZone: 'UTC'}));
      utc.setHours(utc.getHours() + 2);
      const yyyy = utc.getFullYear();
      const mm = String(utc.getMonth()+1).padStart(2,'0');
      const dd = String(utc.getDate()).padStart(2,'0');
      return `${yyyy}-${mm}-${dd}`;
    }
  }

  // Formatiraj sate i minute u "HH:mm"
  function formatTime(h, m) {
    return String(h).padStart(2,'0') + ':' + String(m).padStart(2,'0');
  }

  // Učitaj termine sa SheetDB za dati datum
  async function fetchTermini(datum) {
    const url = `${apiBase}?Datum=${datum}`;
    try {
      const res = await fetch(url);
      if(!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();
      return data;
    } catch(err) {
      console.error('Greska pri ucitavanju termina:', err);
      return [];
    }
  }

  // Sačuvaj termin (POST ili PUT)
  async function sacuvajTermin(datum, termin, dataObj) {
    // Provera da li postoji zapis za datum+termin
    const existing = await fetchTermini(datum);
    const postoji = existing.find(r => r.Vreme === termin);

    const payload = {
      Datum: datum,
      Vreme: termin,
      'Šifra stana': dataObj.sifraStana || '',
      Agent: dataObj.agent || '',
      Adresa: dataObj.adresa || '',
      Telefon: dataObj.telefon || '',
      Slikano: dataObj.slikano ? 'Da' : 'Ne'
    };

    try {
      if (postoji) {
        // update sa PATCH (SheetDB podržava)
        const patchUrl = `${apiBase}/Datum/${datum}/Vreme/${termin}`;
        const res = await fetch(patchUrl, {
          method: 'PATCH',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({data: [payload]}),
        });
        if(!res.ok) throw new Error(`HTTP ${res.status}`);
      } else {
        // novi unos POST
        const res = await fetch(apiBase, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({data: [payload]}),
        });
        if(!res.ok) throw new Error(`HTTP ${res.status}`);
      }
      alert('Uspešno sačuvano!');
    } catch(err) {
      alert('Greška prilikom čuvanja: ' + err.message);
      console.error(err);
    }
  }

  // Renderuj sve termine u slotove (kartice)
  function renderTermini(datum, termini) {
    const container = document.getElementById('slotsContainer');
    container.innerHTML = '';

    for(let h = startHour; h <= endHour; h++) {
      for(let m = 0; m < 60; m += intervalMinutes) {
        const vremeStr = formatTime(h,m);
        const terminData = termini.find(t => t.Vreme === vremeStr) || null;

        const card = document.createElement('div');
        card.className = 'slotCard';
        if(terminData && (terminData.Agent || terminData.Adresa || terminData['Šifra stana'] || terminData.Telefon)) {
          card.classList.add('filled');
        }

        const label = document.createElement('label');
        label.textContent = vremeStr;
        card.appendChild(label);

        const sifraInput = document.createElement('input');
        sifraInput.placeholder = 'Šifra stana';
        sifraInput.value = terminData ? terminData['Šifra stana'] : '';
        card.appendChild(sifraInput);

        const agentInput = document.createElement('input');
        agentInput.placeholder = 'Agent';
        agentInput.value = terminData ? terminData.Agent : '';
        card.appendChild(agentInput);

        const adresaInput = document.createElement('input');
        adresaInput.placeholder = 'Adresa';
        adresaInput.value = terminData ? terminData.Adresa : '';
        card.appendChild(adresaInput);

        const telefonInput = document.createElement('input');
        telefonInput.placeholder = 'Telefon';
        telefonInput.type = 'tel';
        telefonInput.value = terminData ? terminData.Telefon : '';
        card.appendChild(telefonInput);

        const slikanoLabel = document.createElement('label');
        slikanoLabel.style.fontWeight = 'normal';
        slikanoLabel.style.fontSize = '13px';
        slikanoLabel.textContent = 'Slikano ';
        const slikanoCheckbox = document.createElement('input');
        slikanoCheckbox.type = 'checkbox';
        slikanoCheckbox.checked = terminData ? (terminData.Slikano === 'Da') : false;
        slikanoLabel.appendChild(slikanoCheckbox);
        card.appendChild(slikanoLabel);

        const saveBtn = document.createElement('button');
        saveBtn.textContent = 'Sačuvaj';
        saveBtn.onclick = () => {
          const dataToSave = {
            sifraStana: sifraInput.value.trim(),
            agent: agentInput.value.trim(),
            adresa: adresaInput.value.trim(),
            telefon: telefonInput.value.trim(),
            slikano: slikanoCheckbox.checked
          };
          sacuvajTermin(datum, vremeStr, dataToSave);
        };
        card.appendChild(saveBtn);

        container.appendChild(card);
      }
    }
  }

  // Inicijalizacija
  async function init() {
    const datePicker = document.getElementById('datePicker');
    const danasnjiDatum = getTodaySerbiaDate();
    datePicker.value = danasnjiDatum;

    datePicker.onchange = async () => {
      const datum = datePicker.value;
      const termini = await fetchTermini(datum);
      renderTermini(datum, termini);
    };

    const termini = await fetchTermini(danasnjiDatum);
    renderTermini(danasnjiDatum, termini);
  }

  window.onload = init;
</script>
</body>
</html>
