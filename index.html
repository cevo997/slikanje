<!DOCTYPE html>
<html lang="sr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Zakazivanje Slikanja</title>
<style>
  body { font-family: Arial, sans-serif; padding: 20px; background: #eef1f5; }
  h1 { text-align: center; margin-bottom: 20px; }
  .day { max-width: 900px; margin: 0 auto; }
  .grid {
    display: grid;
    grid-template-columns: repeat(auto-fill,minmax(260px,1fr));
    gap: 15px;
  }
  .slot {
    background: white;
    padding: 10px;
    border-radius: 8px;
    box-shadow: 0 0 8px rgba(0,0,0,0.1);
  }
  .slot h4 {
    margin: 0 0 8px 0;
    font-size: 16px;
  }
  .slot input[type=text], .slot input[type=tel] {
    width: 100%;
    padding: 6px;
    margin-bottom: 6px;
    border: 1px solid #ccc;
    border-radius: 4px;
    box-sizing: border-box;
  }
  .slot label {
    display: block;
    margin-bottom: 8px;
    font-size: 14px;
  }
  .slot button {
    width: 100%;
    padding: 8px;
    background: #1a73e8;
    border: none;
    color: white;
    font-size: 14px;
    border-radius: 4px;
    cursor: pointer;
  }
  .slot.filled {
    background: #d4edda;
  }
  #datumSelector {
    display: block;
    margin: 0 auto 20px auto;
    padding: 6px 10px;
    font-size: 16px;
    border-radius: 5px;
  }
  #statusMsg {
    text-align: center;
    margin-bottom: 15px;
    color: #333;
    font-weight: bold;
  }
</style>
</head>
<body>

<h1>Zakazivanje Slikanja</h1>

<select id="datumSelector"></select>
<div id="statusMsg"></div>
<div class="day">
  <div class="grid" id="gridSlots"></div>
</div>

<script>
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbx92rijxyw9xRa0vVm-xdglde6XIzoJ-ZTjQPRFQLuxcGBBtmKDx56nyYn-GCJ7lBzwCQ/exec"; // zameni ovde

  const startHour = 9;
  const endHour = 19;
  const interval = 30;

  let currentDate = new Date();
  let datumKey = formatDateISO(currentDate);

  function formatDateISO(d) {
    return d.toISOString().split("T")[0];
  }

  function formatDateDisplay(d) {
    return d.split("-").reverse().join(".");
  }

  function generateTimeSlots() {
    const slots = [];
    for(let h = startHour; h <= endHour; h++) {
      for(let m = 0; m < 60; m += interval) {
        slots.push(`${String(h).padStart(2,"0")}:${String(m).padStart(2,"0")}`);
      }
    }
    return slots;
  }

  async function fetchSlots(dateStr) {
    try {
      const res = await fetch(`${SCRIPT_URL}?action=getByDate&datum=${dateStr}`);
      if(!res.ok) throw new Error("Network error");
      const data = await res.json();
      return data;
    } catch(e) {
      document.getElementById("statusMsg").textContent = "Greška pri učitavanju podataka.";
      return [];
    }
  }

  async function saveSlot(dateStr, timeStr, slotData, btn) {
    try {
      btn.disabled = true;
      btn.textContent = "Čuvanje...";

      const params = new URLSearchParams({
        action: "update",
        datum: dateStr,
        termin: timeStr,
        sifraStana: slotData.sifra || "",
        agent: slotData.agent || "",
        adresa: slotData.adresa || "",
        telefon: slotData.telefon || "",
        slikano: slotData.slikano ? "true" : "false"
      });

      const res = await fetch(`${SCRIPT_URL}?${params.toString()}`);
      const json = await res.json();

      if (json.status === "success") {
        btn.textContent = "Sačuvano ✔";
        btn.parentElement.classList.add("filled");
      } else {
        btn.textContent = "Greška!";
      }

      setTimeout(() => {
        btn.disabled = false;
        btn.textContent = "Sačuvaj";
      }, 1500);

    } catch(e) {
      btn.textContent = "Greška!";
      btn.disabled = false;
    }
  }

  function renderSlots(dateStr, data) {
    const grid = document.getElementById("gridSlots");
    grid.innerHTML = "";

    const slots = generateTimeSlots();

    slots.forEach(time => {
      const slotData = data.find(d => d.Termin === time) || {
        SifraStana: "", Agent: "", Adresa: "", Telefon: "", Slikano: false
      };

      const div = document.createElement("div");
      div.className = "slot";
      if(slotData.SifraStana || slotData.Agent || slotData.Adresa || slotData.Telefon) {
        div.classList.add("filled");
      }

      div.innerHTML = `
        <h4>${time}</h4>
        <input type="text" placeholder="Šifra stana" class="sifra" value="${slotData.SifraStana}" />
        <input type="text" placeholder="Agent" class="agent" value="${slotData.Agent}" />
        <input type="text" placeholder="Adresa" class="adresa" value="${slotData.Adresa}" />
        <input type="tel" placeholder="Telefon" class="telefon" value="${slotData.Telefon}" />
        <label><input type="checkbox" class="slikano" ${slotData.Slikano ? "checked" : ""} /> Slikano</label>
        <button>Sačuvaj</button>
      `;

      const btn = div.querySelector("button");
      btn.onclick = () => {
        const novaVrednost = {
          sifra: div.querySelector(".sifra").value,
          agent: div.querySelector(".agent").value,
          adresa: div.querySelector(".adresa").value,
          telefon: div.querySelector(".telefon").value,
          slikano: div.querySelector(".slikano").checked
        };
        saveSlot(dateStr, time, novaVrednost, btn);
      };

      grid.appendChild(div);
    });
  }

  function populateDateSelector() {
    const sel = document.getElementById("datumSelector");
    sel.innerHTML = "";

    // Ubaci danas i narednih 7 dana
    for(let i=0; i<=7; i++) {
      const d = new Date();
      d.setDate(d.getDate() + i);
      const iso = formatDateISO(d);
      const opt = document.createElement("option");
      opt.value = iso;
      opt.textContent = formatDateDisplay(iso);
      if(iso === datumKey) opt.selected = true;
      sel.appendChild(opt);
    }
  }

  async function loadAndRender(dateStr) {
    document.getElementById("statusMsg").textContent = "Učitavanje...";
    const data = await fetchSlots(dateStr);
    renderSlots(dateStr, data);
    document.getElementById("statusMsg").textContent = "";
  }

  document.getElementById("datumSelector").addEventListener("change", e => {
    datumKey = e.target.value;
    loadAndRender(datumKey);
  });

  async function sendReminder() {
    // poziv akcije za slanje emaila
    const res = await fetch(`${SCRIPT_URL}?action=sendReminder`);
    const json = await res.json();
    if(json.status === "reminder_sent") {
      alert("Obaveštenje poslato na email.");
    } else if(json.status === "no_reminder") {
      alert("Nema nečekiranih termina za podsetnik.");
    }
  }

  window.onload = () => {
    populateDateSelector();
    loadAndRender(datumKey);
    // primer: svakih 12 sati šalje podsetnik (može se zakazati i u GAS cron)
    // setInterval(sendReminder, 12 * 60 * 60 * 1000);
  };
</script>

</body>
</html>
