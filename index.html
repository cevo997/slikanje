<!DOCTYPE html>
<html lang="sr">
<head>
  <meta charset="UTF-8">
  <title>Zakazivanje slikanja</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
      background: #f5f5f5;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 12px;
    }
    .card {
      background: white;
      padding: 12px;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      transition: background 0.3s;
    }
    .card.dim {
      background: #d3d3d3;
    }
    .card input, .card select {
      width: 100%;
      padding: 4px;
      margin: 4px 0;
    }
    .card button {
      margin-top: 6px;
      width: 100%;
      padding: 6px;
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>Zakazivanje slikanja</h1>
    <input type="date" id="datum" />
  </div>
  <div id="termini" class="grid"></div>

  <script>
    const API_URL = 'https://sheetdb.io/api/v1/ywvbhlm9ikdui';
    const agenti = ["SAŠKA", "CECA", "LJILJA", "RUŽA", "SEKA", "SANDRA", "NIKOLA", "ANĐELA", "ATINA", "VIŠNJA", "MILA", "BUDA", "NATAŠA"];
    const vremena = Array.from({length: 22}, (_, i) => {
      let h = 9 + Math.floor(i / 2);
      let m = i % 2 === 0 ? '00' : '30';
      return `${String(h).padStart(2, '0')}:${m}`;
    });

    let sviPodaci = [];

    document.getElementById('datum').valueAsDate = new Date();
    document.getElementById('datum').addEventListener('change', ucitajTermine);

    async function ucitajTermine() {
      const datum = document.getElementById('datum').value;
      const res = await fetch(`${API_URL}?search=Datum&value=${datum}`);
      sviPodaci = await res.json();

      const container = document.getElementById('termini');
      container.innerHTML = '';

      vremena.forEach(vreme => {
        const podatak = sviPodaci.find(p => p.Vreme === vreme);
        const div = document.createElement('div');
        div.className = 'card';
        if (podatak && podatak.Slikano === 'Da') div.classList.add('dim');

        div.innerHTML = `
          <strong>${vreme}</strong>
          <input placeholder="Šifra stana" value="${podatak?.['Šifra stana'] || ''}" />
          <select>
            <option value="">-- Agent --</option>
            ${agenti.map(a => `<option value="${a}" ${podatak?.Agent === a ? 'selected' : ''}>${a}</option>`).join('')}
          </select>
          <input placeholder="Adresa" value="${podatak?.Adresa || ''}" />
          <input placeholder="Telefon" value="${podatak?.Telefon || ''}" />
          <label><input type="checkbox" ${podatak?.Slikano === 'Da' ? 'checked' : ''} /> Slikano</label>
          <button>Sačuvaj</button>
        `;

        const [sifra, agent, adresa, telefon] = div.querySelectorAll('input, select');
        const slikano = div.querySelector('input[type="checkbox"]');
        const dugme = div.querySelector('button');

        slikano.addEventListener('change', () => {
          div.classList.toggle('dim', slikano.checked);
        });

        dugme.onclick = async () => {
          const podaci = {
            Datum: datum,
            Vreme: vreme,
            "Šifra stana": sifra.value,
            Agent: agent.value,
            Adresa: adresa.value,
            Telefon: telefon.value,
            Slikano: slikano.checked ? 'Da' : 'Ne'
          };

          const postoji = sviPodaci.find(p => p.Vreme === vreme);
          if (postoji) {
            // Update
            await fetch(`${API_URL}/search?Datum=${datum}&Vreme=${vreme}`, {
              method: 'PATCH',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ data: podaci })
            });
          } else {
            // Insert
            await fetch(API_URL, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ data: podaci })
            });
          }
          alert('Sačuvano');
        };

        container.appendChild(div);
      });

      prikaziBrojSlikanih();
    }

    function prikaziBrojSlikanih() {
      const brojac = {};
      sviPodaci.forEach(p => {
        if (p.Slikano === 'Da' && p.Agent) {
          brojac[p.Agent] = (brojac[p.Agent] || 0) + 1;
        }
      });
      console.log('Broj slikanih po agentima:', brojac);
    }

    // Pokreni odmah
    ucitajTermine();
  </script>
</body>
</html>
