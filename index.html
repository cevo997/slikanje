<!DOCTYPE html>
<html lang="sr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Zakazivanje Slikanja - SheetDB</title>
<style>
  body {
    font-family: Arial, sans-serif;
    margin: 20px;
    background: #f0f2f5;
  }
  h1 {
    text-align: center;
  }
  #datePicker {
    margin-bottom: 20px;
    display: block;
    margin-left: auto;
    margin-right: auto;
  }
  #terminiContainer {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
    justify-content: center;
  }
  .terminCard {
    background: white;
    border-radius: 8px;
    box-shadow: 0 0 8px rgba(0,0,0,0.1);
    padding: 15px;
    width: 250px;
    box-sizing: border-box;
    display: flex;
    flex-direction: column;
    gap: 8px;
  }
  .terminCard input[type=text], .terminCard input[type=tel] {
    width: 100%;
    padding: 6px;
    font-size: 14px;
    border: 1px solid #ccc;
    border-radius: 4px;
  }
  .btnGroup {
    display: flex;
    justify-content: space-between;
  }
  button {
    padding: 7px 12px;
    font-size: 14px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
  }
  button.saveBtn {
    background-color: #4caf50;
    color: white;
  }
  button.deleteBtn {
    background-color: #e74c3c;
    color: white;
  }
</style>
</head>
<body>

<h1>Zakazivanje Slikanja</h1>
<input type="date" id="datePicker" />

<div id="terminiContainer"></div>

<script>
const API_BASE = 'https://sheetdb.io/api/v1/ywvbhlm9ikdui';

// Konvertuje Excel datum decimal u ISO string
function excelDateToISO(serial) {
  if (typeof serial === 'number') {
    const utc_days = Math.floor(serial - 25569);
    const utc_value = utc_days * 86400;
    const date_info = new Date(utc_value * 1000);
    const year = date_info.getUTCFullYear();
    const month = (date_info.getUTCMonth() + 1).toString().padStart(2, '0');
    const day = date_info.getUTCDate().toString().padStart(2, '0');
    return `${year}-${month}-${day}`;
  } else {
    return serial;
  }
}

function fetchTermini(datum) {
  // SheetDB filter po datumu
  return fetch(`${API_BASE}?Datum=${datum}`)
    .then(res => res.json())
    .then(data => {
      // Podaci u data su niz objekata sa kolonama
      return data.map(row => ({
        id: row._id || '',
        datum: excelDateToISO(row.Datum),
        vreme: row.Vreme || '',
        sifraStana: row['Šifra stana'] || '',
        agent: row.Agent || '',
        adresa: row.Adresa || '',
        telefon: row.Telefon || '',
        slikano: row.Slikano === 'Da'
      }));
    });
}

function sacuvajTermin(termin) {
  // Ako ima ID, update; ako nema, create
  if (termin.id) {
    return fetch(`${API_BASE}/${termin.id}`, {
      method: 'PUT',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({data: [termin]})
    }).then(res => res.json());
  } else {
    return fetch(API_BASE, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({data: [termin]})
    }).then(res => res.json());
  }
}

function obrisiTermin(id) {
  if (!id) return Promise.reject('Nema ID za brisanje');
  return fetch(`${API_BASE}/${id}`, {
    method: 'DELETE'
  }).then(res => res.json());
}

function kreirajKarticu(termin) {
  const card = document.createElement('div');
  card.className = 'terminCard';

  const vreme = document.createElement('div');
  vreme.textContent = 'Vreme: ' + (termin.vreme || '');
  card.appendChild(vreme);

  const sifraInput = document.createElement('input');
  sifraInput.type = 'text';
  sifraInput.placeholder = 'Šifra stana';
  sifraInput.value = termin.sifraStana;
  card.appendChild(sifraInput);

  const agentInput = document.createElement('input');
  agentInput.type = 'text';
  agentInput.placeholder = 'Agent';
  agentInput.value = termin.agent;
  card.appendChild(agentInput);

  const adresaInput = document.createElement('input');
  adresaInput.type = 'text';
  adresaInput.placeholder = 'Adresa';
  adresaInput.value = termin.adresa;
  card.appendChild(adresaInput);

  const telefonInput = document.createElement('input');
  telefonInput.type = 'tel';
  telefonInput.placeholder = 'Telefon';
  telefonInput.value = termin.telefon;
  card.appendChild(telefonInput);

  const slikanoLabel = document.createElement('label');
  slikanoLabel.style.display = 'flex';
  slikanoLabel.style.alignItems = 'center';

  const slikanoCheckbox = document.createElement('input');
  slikanoCheckbox.type = 'checkbox';
  slikanoCheckbox.checked = termin.slikano;

  slikanoLabel.appendChild(slikanoCheckbox);
  slikanoLabel.appendChild(document.createTextNode(' Slikano'));
  card.appendChild(slikanoLabel);

  // Dugmad
  const btnGroup = document.createElement('div');
  btnGroup.className = 'btnGroup';

  const saveBtn = document.createElement('button');
  saveBtn.textContent = 'Sačuvaj';
  saveBtn.className = 'saveBtn';
  saveBtn.onclick = () => {
    const noviTermin = {
      id: termin.id,
      Datum: document.getElementById('datePicker').value,
      Vreme: vreme.textContent.replace('Vreme: ', ''),
      'Šifra stana': sifraInput.value.trim(),
      Agent: agentInput.value.trim(),
      Adresa: adresaInput.value.trim(),
      Telefon: telefonInput.value.trim(),
      Slikano: slikanoCheckbox.checked ? 'Da' : 'Ne'
    };
    sacuvajTermin(noviTermin).then(() => {
      alert('Termin sačuvan!');
      // Refresuj da vidiš ID koji je dodeljen ako je novi termin
      ucitajIPrikaziTermine();
    });
  };

  const deleteBtn = document.createElement('button');
  deleteBtn.textContent = 'Obriši';
  deleteBtn.className = 'deleteBtn';
  deleteBtn.onclick = () => {
    if (!termin.id) {
      alert('Ne može se obrisati nepostojeći termin.');
      return;
    }
    if (confirm('Da li ste sigurni da želite da obrišete termin?')) {
      obrisiTermin(termin.id).then(() => {
        alert('Termin obrisan!');
        ucitajIPrikaziTermine();
      });
    }
  };

  btnGroup.appendChild(saveBtn);
  btnGroup.appendChild(deleteBtn);
  card.appendChild(btnGroup);

  return card;
}

function ucitajIPrikaziTermine() {
  const datum = document.getElementById('datePicker').value;
  if (!datum) return;
  fetchTermini(datum).then(termini => {
    const container = document.getElementById('terminiContainer');
    container.innerHTML = '';
    if (termini.length === 0) {
      container.textContent = 'Nema termina za ovaj datum.';
      return;
    }
    termini.forEach(t => {
      container.appendChild(kreirajKarticu(t));
    });
  });
}

// Postavi danasnji datum kao default
document.getElementById('datePicker').valueAsDate = new Date();
document.getElementById('datePicker').addEventListener('change', ucitajIPrikaziTermine);

// Ucitaj za danas
ucitajIPrikaziTermine();
</script>
</body>
</html>
