<!DOCTYPE html>
<html lang="sr">
<head>
  <meta charset="UTF-8" />
  <title>Zakazivanje slikanja</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
      background: #f5f5f5;
    }
    h1 {
      text-align: center;
    }
    .selector {
      margin-bottom: 20px;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
      gap: 12px;
    }
    .kartica {
      background: white;
      padding: 10px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .kartica input, .kartica textarea {
      width: 100%;
      margin: 4px 0;
      padding: 4px;
    }
    .kartica label {
      font-weight: bold;
      font-size: 12px;
    }
    .sacuvajBtn {
      margin-top: 6px;
      background: #4caf50;
      color: white;
      border: none;
      padding: 6px 10px;
      cursor: pointer;
      border-radius: 4px;
    }
    .sacuvajBtn:hover {
      background: #45a049;
    }
  </style>
</head>
<body>
  <h1>Zakazivanje Slikanja</h1>
  <div class="selector">
    <label for="izborDatuma">Izaberi datum:</label>
    <input type="date" id="izborDatuma" onchange="promeniDatum(this.value)">
  </div>
  <div id="termini" class="grid"></div>

  <script>
    const terminiPoVremenu = [
      "09:00", "09:30", "10:00", "10:30", "11:00", "11:30",
      "12:00", "12:30", "13:00", "13:30", "14:00", "14:30",
      "15:00", "15:30", "16:00", "16:30", "17:00", "17:30",
      "18:00", "18:30", "19:00", "19:30"
    ];

    let sviTermini = [];

    function formatirajDatum(d) {
      const date = new Date(d);
      return date.toLocaleDateString("sr-RS", {
        day: "2-digit", month: "2-digit", year: "numeric"
      });
    }

    function promeniDatum(datum) {
      const kontejner = document.getElementById("termini");
      kontejner.innerHTML = "";
      const danas = formatirajDatum(datum);

      for (let vreme of terminiPoVremenu) {
        const kartica = document.createElement("div");
        kartica.className = "kartica";

        kartica.innerHTML = `
          <label>Vreme: ${vreme}</label><br>
          <label>Šifra stana</label><input type="text" class="sifra"><br>
          <label>Agent</label><input type="text" class="agent"><br>
          <label>Adresa</label><input type="text" class="adresa"><br>
          <label>Telefon</label><input type="text" class="telefon"><br>
          <label>Slikano:</label><input type="checkbox" class="slikano"><br>
          <button class="sacuvajBtn" onclick="sacuvaj(this, '${danas}', '${vreme}')">Sačuvaj</button>
        `;
        kontejner.appendChild(kartica);
      }

      // Povući podatke iz sheeta
      const url = 'https://script.google.com/macros/s/AKfycbxT38AbXBtxhUsrq2Mlk-4eTIOI1yDeRIoklArbf9xScx52tryPKdaIGHwJvXih92cFGQ/exec?callback=ucitaj&datum=' + encodeURIComponent(danas);
      const s = document.createElement('script');
      s.src = url;
      document.body.appendChild(s);
    }

    function ucitaj(podaci) {
      sviTermini = podaci;
      const kartice = document.querySelectorAll(".kartica");

      for (let red of podaci) {
        const [datum, vreme, sifra, agent, adresa, telefon, slikano] = red;
        for (let kartica of kartice) {
          if (kartica.innerHTML.includes(`Vreme: ${vreme}`)) {
            kartica.querySelector(".sifra").value = sifra;
            kartica.querySelector(".agent").value = agent;
            kartica.querySelector(".adresa").value = adresa;
            kartica.querySelector(".telefon").value = telefon;
            kartica.querySelector(".slikano").checked = slikano === "Da";
          }
        }
      }
    }

    function sacuvaj(dugme, datum, vreme) {
      const kartica = dugme.parentElement;
      const sifra = kartica.querySelector(".sifra").value;
      const agent = kartica.querySelector(".agent").value;
      const adresa = kartica.querySelector(".adresa").value;
      const telefon = kartica.querySelector(".telefon").value;
      const slikano = kartica.querySelector(".slikano").checked ? "Da" : "Ne";

      const podaci = {
        datum, vreme, sifra, agent, adresa, telefon, slikano
      };

      const query = Object.keys(podaci)
        .map(k => `${k}=${encodeURIComponent(podaci[k])}`)
        .join("&");

      const url = "https://script.google.com/macros/s/AKfycbxT38AbXBtxhUsrq2Mlk-4eTIOI1yDeRIoklArbf9xScx52tryPKdaIGHwJvXih92cFGQ/exec?" + query;
      fetch(url)
        .then(res => {
          if (res.ok) alert("Uspešno sačuvano!");
          else alert("Greška pri čuvanju!");
        });
    }

    // Automatski postavi današnji datum pri učitavanju
    window.onload = () => {
      const danas = new Date().toISOString().split("T")[0];
      document.getElementById("izborDatuma").value = danas;
      promeniDatum(danas);
    };
  </script>
</body>
</html>
