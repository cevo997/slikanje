<!DOCTYPE html>
<html lang="sr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Zakazivanje Slikanja</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #eef1f5;
      margin: 0;
      padding: 20px;
    }
    h1 {
      text-align: center;
      color: #333;
    }
    .selector {
      text-align: center;
      margin-bottom: 15px;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
      gap: 15px;
      max-width: 1200px;
      margin: 0 auto;
    }
    .time-slot {
      background: #fff;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      position: relative;
      border: 2px solid transparent;
      transition: border-color 0.3s;
    }
    .time-slot.filled {
      border-color: #4CAF50;
      background: #e8f5e9;
    }
    .time-slot h4 {
      margin: 0 0 10px 0;
      font-size: 16px;
      text-align: center;
      color: #222;
    }
    .time-slot input[type="text"],
    .time-slot input[type="tel"] {
      width: 100%;
      padding: 6px;
      margin-bottom: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 14px;
      box-sizing: border-box;
      text-align: center;
    }
    .slikano-label {
      position: absolute;
      top: 10px;
      right: 10px;
      font-size: 14px;
      color: #333;
      user-select: none;
    }
    .slikano-label input {
      margin-right: 5px;
      transform: scale(1.2);
    }
  </style>
</head>
<body>

  <h1>Zakazivanje Slikanja</h1>

  <div class="selector">
    <label for="datumSelect">Izaberi datum: </label>
    <input type="date" id="datumSelect" />
  </div>

  <div id="schedule" class="grid">Učitavanje termina...</div>

<script>
  const SCRIPT_URL = 'TVOJ_DEPLOY_URL_OD_APPS_SCRIPT'; // OVDE ZAMENI SA TVOJIM URL

  const startHour = 9;
  const endHour = 19;
  const interval = 30; // minuta

  // Inicijalni datum - danas u Srbiji (UTC+2)
  function getTodaySerbiaISO() {
    const now = new Date();
    const utc = now.getTime() + (now.getTimezoneOffset() * 60000);
    const serbiaTime = new Date(utc + (2 * 3600000));
    return serbiaTime.toISOString().slice(0,10);
  }

  const datumInput = document.getElementById('datumSelect');
  const scheduleDiv = document.getElementById('schedule');

  datumInput.value = getTodaySerbiaISO();

  datumInput.addEventListener('change', () => {
    loadSchedule(datumInput.value);
  });

  // JSONP helper
  function jsonp(url, callbackName) {
    return new Promise((resolve, reject) => {
      const script = document.createElement('script');
      const name = 'jsonp_callback_' + Math.round(100000 * Math.random());

      window[name] = function(data) {
        delete window[name];
        document.body.removeChild(script);
        resolve(data);
      };

      script.src = `${url}&callback=${name}`;
      script.onerror = reject;
      document.body.appendChild(script);
    });
  }

  function loadSchedule(datum) {
    scheduleDiv.innerHTML = 'Učitavanje termina...';

    const url = `${SCRIPT_URL}?action=getByDate&datum=${datum}`;
    jsonp(url)
      .then(response => {
        if(response.status === 'success') {
          renderSchedule(datum, response.data);
        } else {
          scheduleDiv.innerHTML = 'Greška pri učitavanju termina.';
        }
      })
      .catch(() => {
        scheduleDiv.innerHTML = 'Greška pri komunikaciji sa serverom.';
      });
  }

  function renderSchedule(datum, termini) {
    scheduleDiv.innerHTML = '';

    // Kreiramo mapu za lakše pronalaženje termina po vremenu i šifri
    const terminiMap = {};
    termini.forEach(t => {
      terminiMap[t.termin + '_' + t.sifraStana] = t;
    });

    for(let h = startHour; h <= endHour; h++) {
      for(let m = 0; m < 60; m += interval) {
        const pad = n => n.toString().padStart(2, '0');
        const vreme = `${pad(h)}:${pad(m)}`;

        // Tražimo da li postoji termin za ovo vreme
        // Ako nema ni jednog sa tom šifrom, prikažemo prazno polje
        // Ali da bismo olakšali, prikažemo prazno polje sa praznim vrednostima

        // U ovom primeru prikazujemo samo po vremenu, po šifri stana termin unosimo direktno ručno
        // Dakle, prazno polje

        // Ako ima termin sa nekom sifrom za ovo vreme, možemo ih prikazati ili pustiti korisnika da upiše novu

        // Za prost primer prikaza jedan termin po vremenu

        // Provera ako je termin zauzet - na osnovu prvog termina koji nađemo na to vreme
        const keyPrefix = vreme + '_'; // po sifri nema filtriranja
        let existingTermin = termini.find(t => t.termin === vreme);

        const slotData = existingTermin || {
          sifraStana: '',
          agent: '',
          adresa: '',
          telefon: '',
          slikano: 'Ne'
        };

        const div = document.createElement('div');
        div.className = 'time-slot';
        if(slotData.sifraStana) {
          div.classList.add('filled');
        }

        div.innerHTML = `
          <h4>${vreme}</h4>
          <input type="text" placeholder="Šifra stana" value="${slotData.sifraStana}" />
          <input type="text" placeholder="Agent" value="${slotData.agent}" />
          <input type="text" placeholder="Adresa" value="${slotData.adresa}" />
          <input type="tel" placeholder="Telefon" value="${slotData.telefon}" />
          <label class="slikano-label">
            <input type="checkbox" ${slotData.slikano === 'Da' ? 'checked' : ''} />
            Slikano
          </label>
        `;

        // Dodaj event listener za čuvanje podataka na promenu
        const inputs = div.querySelectorAll('input');
        inputs.forEach(input => {
          input.addEventListener('change', () => {
            const sifra = div.querySelector('input[placeholder="Šifra stana"]').value.trim();
            const agent = div.querySelector('input[placeholder="Agent"]').value.trim();
            const adresa = div.querySelector('input[placeholder="Adresa"]').value.trim();
            const telefon = div.querySelector('input[placeholder="Telefon"]').value.trim();
            const slikano = div.querySelector('input[type="checkbox"]').checked;

            if(!sifra) {
              alert('Unesite šifru stana pre čuvanja!');
              return;
            }

            // Salji update preko JSONP poziva na Apps Script
            const params = new URLSearchParams({
              action: 'update',
              datum,
              termin: vreme,
              sifraStana: sifra,
              agent,
              adresa,
              telefon,
              slikano: slikano ? 'Da' : 'Ne'
            });

            // Koristimo fetch ne ide zbog CORS, koristimo JSONP funkciju:
            const url = `${https://script.google.com/macros/s/AKfycbwvhs_GugyaKR0-HBug31gSEvMS3NGEek3Ky0rg3VQ2OnzMy9oCJKoUlfzS29OcfR_iMQ/exec}?${params.toString()}`;
            jsonp(url)
              .then(resp => {
                if(resp.status === 'success') {
                  div.classList.toggle('filled', sifra.length > 0);
                } else {
                  alert('Greška pri čuvanju: ' + resp.message);
                }
              })
              .catch(() => {
                alert('Greška pri komunikaciji sa serverom.');
              });
          });
        });

        scheduleDiv.appendChild(div);
      }
    }
  }

  loadSchedule(datumInput.value);
</script>

</body>
</html>
