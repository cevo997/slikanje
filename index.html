<!DOCTYPE html>
<html lang="sr">
<head>
  <meta charset="UTF-8" />
  <title>Zakazivanje slikanja</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
    }
    .kartica {
      display: inline-block;
      width: 220px;
      border: 1px solid #ccc;
      border-radius: 8px;
      margin: 5px;
      padding: 10px;
      background: #f9f9f9;
      vertical-align: top;
      transition: background 0.3s;
    }
    .kartica.zatamnjeno {
      background: #ddd;
    }
    label {
      display: block;
      margin-top: 5px;
    }
    input, select {
      width: 100%;
      padding: 4px;
      margin-top: 2px;
    }
    button {
      margin-top: 8px;
      width: 100%;
      padding: 6px;
    }
    .agent-brojac {
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <h1>Zakazivanje slikanja</h1>
  <div id="kartice"></div>
  <div class="agent-brojac" id="brojaci"></div>

  <script>
    const API_URL = 'https://sheetdb.io/api/v1/ywvbhlm9ikdui';
    const agenti = ["SAŠKA","CECA","LJILJA","RUŽA","SEKA","SANDRA","NIKOLA","ANĐELA","ATINA","VIŠNJA","MILA","BUDA","NATAŠA"];
    const vremeTermina = [
      "09:00","09:30","10:00","10:30","11:00","11:30","12:00","12:30",
      "13:00","13:30","14:00","14:30","15:00","15:30","16:00","16:30",
      "17:00","17:30","18:00","18:30","19:00","19:30"
    ];

    let agentBrojanja = {};

    agenti.forEach(a => agentBrojanja[a] = 0);

    const danas = new Date();
    const datumSrbija = new Date(danas.toLocaleString("en-US", {timeZone: "Europe/Belgrade"}))
      .toISOString().split("T")[0];

    async function ucitajTermine() {
      const res = await fetch(`${API_URL}?search=Datum&value=${datumSrbija}`);
      const podaci = await res.json();
      const mapa = {};
      podaci.forEach(el => {
        mapa[el.Vreme] = el;
        if (el.Slikano === "on" && agenti.includes(el.Agent)) {
          agentBrojanja[el.Agent]++;
        }
      });
      crtajKartice(mapa);
    }

    function crtajKartice(mapa) {
      const kont = document.getElementById("kartice");
      kont.innerHTML = "";

      vremeTermina.forEach(vreme => {
        const pod = mapa[vreme] || {};
        const div = document.createElement("div");
        div.className = "kartica";
        if (pod.Slikano === "on") div.classList.add("zatamnjeno");

        div.innerHTML = `
          <h4>${vreme}</h4>
          <label>Šifra stana: <input type="text" value="${pod['Šifra stana'] || ''}"></label>
          <label>Agent:
            <select>
              <option value="">Izaberi</option>
              ${agenti.map(ag => `<option ${pod.Agent === ag ? 'selected' : ''}>${ag}</option>`).join("")}
            </select>
          </label>
          <label>Adresa: <input type="text" value="${pod.Adresa || ''}"></label>
          <label>Telefon: <input type="text" value="${pod.Telefon || ''}"></label>
          <label><input type="checkbox" ${pod.Slikano === "on" ? 'checked' : ''}> Slikano</label>
          <button>Sačuvaj</button>
        `;

        const btn = div.querySelector("button");
        btn.onclick = async () => {
          const sifra = div.querySelector("input[type='text']").value.trim();
          const agent = div.querySelector("select").value;
          const adresa = div.querySelectorAll("input[type='text']")[1].value.trim();
          const telefon = div.querySelectorAll("input[type='text']")[2].value.trim();
          const slikano = div.querySelector("input[type='checkbox']").checked;

          const data = {
            Datum: datumSrbija,
            Vreme: vreme,
            "Šifra stana": sifra,
            Agent: agent,
            Adresa: adresa,
            Telefon: telefon,
            Slikano: slikano ? "on" : ""
          };

          await fetch(`${API_URL}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ data })
          });

          alert("Sačuvano!");
          if (slikano && agenti.includes(agent)) {
            agentBrojanja[agent]++;
            div.classList.add("zatamnjeno");
            azurirajBrojace();
          }
        };

        kont.appendChild(div);
      });

      azurirajBrojace();
    }

    function azurirajBrojace() {
      const div = document.getElementById("brojaci");
      div.innerHTML = `<h3>Broj slikanja po agentima:</h3><ul>` +
        agenti.map(ag => `<li>${ag}: ${agentBrojanja[ag]}</li>`).join("") +
        `</ul>`;
    }

    ucitajTermine();
  </script>
</body>
</html>
