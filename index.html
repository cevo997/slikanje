<!DOCTYPE html>
<html lang="sr">
<head>
  <meta charset="UTF-8" />
  <title>Zakazivanje Slikanja</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
      background: #f0f0f0;
    }
    .selector {
      margin-bottom: 20px;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 15px;
    }
    .kartica {
      background: white;
      border: 1px solid #ccc;
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .zatamnjeno {
      background: #ccc;
      opacity: 0.6;
    }
    label {
      display: block;
      margin-top: 5px;
    }
    select, input[type="text"], input[type="tel"] {
      width: 100%;
      padding: 5px;
      margin-top: 2px;
    }
    .brojaci {
      margin-top: 20px;
      font-weight: bold;
    }
    button {
      margin-top: 20px;
      padding: 10px 20px;
      font-size: 16px;
    }
  </style>
</head>
<body>
  <h1>Zakazivanje Slikanja</h1>
  <div class="selector">
    <label for="izborDatuma">Izaberi datum:</label>
    <input type="date" id="izborDatuma" />
  </div>
  <div id="grid" class="grid"></div>
  <button onclick="sacuvaj()">Sačuvaj</button>
  <div id="brojaci" class="brojaci"></div>
<script>
const API_URL = "https://sheetdb.io/api/v1/ywvbhlm9ikdui";
const termini = generisiTermine();
const agenti = ["SAŠKA","CECA","LJILJA","RUŽA","SEKA","SANDRA","NIKOLA","ANĐELA","ATINA","VIŠNJA","MILA","BUDA","NATAŠA"];
let podaci = [];

document.getElementById("izborDatuma").valueAsDate = new Date();
document.getElementById("izborDatuma").addEventListener("change", ucitajPodatke);

function generisiTermine() {
  let list = [];
  for (let h = 9; h <= 19; h++) {
    list.push(`${h.toString().padStart(2, "0")}:00`);
    list.push(`${h.toString().padStart(2, "0")}:30`);
  }
  return list;
}

function ucitajPodatke() {
  const datum = document.getElementById("izborDatuma").value;
  fetch(`${API_URL}?date=${datum}`)
    .then(res => res.json())
    .then(data => {
      podaci = data;
      prikaziTermine(datum);
    });
}

function prikaziTermine(datum) {
  const grid = document.getElementById("grid");
  grid.innerHTML = "";
  const brojaci = {};

  termini.forEach(vreme => {
    const entry = podaci.find(e => e.date === datum && e.time === vreme) || {};
    const div = document.createElement("div");
    div.className = "kartica";
    div.innerHTML = `
      <h4>${vreme}</h4>
      <label>Šifra: <input type="text" value="${entry.sifra || ""}" /></label>
      <label>Adresa: <input type="text" value="${entry.adresa || ""}" /></label>
      <label>Telefon: <input type="tel" value="${entry.telefon || ""}" /></label>
      <label>Agent:
        <select>
          <option value=""></option>
          ${agenti.map(a => `<option value="${a}" ${entry.agent === a ? "selected" : ""}>${a}</option>`).join("")}
        </select>
      </label>
      <label><input type="checkbox" ${entry.slikano === "DA" ? "checked" : ""}/> Slikano</label>
    `;
    if (entry.slikano === "DA") div.classList.add("zatamnjeno");
    div.dataset.vreme = vreme;
    grid.appendChild(div);

    // broji agente
    if (entry.slikano === "DA" && entry.agent) {
      brojaci[entry.agent] = (brojaci[entry.agent] || 0) + 1;
    }

    // proveri za slanje maila
    const danas = new Date();
    const terminDatum = new Date(datum);
    const diff = (danas - terminDatum) / (1000 * 60 * 60 * 24);
    if (diff > 2 && entry.slikano !== "DA" && entry.sifra) {
      fetch("https://formsubmit.co/ajax/stefanbarac@gmail.com", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          subject: "Nije slikano!",
          message: `Stan ${entry.sifra} na adresi ${entry.adresa || "nepoznato"} NIJE slikano (${datum} ${vreme})`
        })
      });
    }
  });

  // prikaz brojača
  const brojaciDiv = document.getElementById("brojaci");
  brojaciDiv.innerHTML = "Broj stanova po agentu: " + Object.entries(brojaci).map(([a, b]) => `${a}: ${b}`).join(", ");
}

function sacuvaj() {
  const datum = document.getElementById("izborDatuma").value;
  const kartice = document.querySelectorAll(".kartica");

  kartice.forEach(div => {
    const vreme = div.dataset.vreme;
    const sifra = div.querySelector("input[type='text']").value;
    const adresa = div.querySelectorAll("input")[1].value;
    const telefon = div.querySelector("input[type='tel']").value;
    const agent = div.querySelector("select").value;
    const slikano = div.querySelector("input[type='checkbox']").checked ? "DA" : "";

    fetch(API_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        data: {
          date: datum,
          time: vreme,
          sifra,
          adresa,
          telefon,
          agent,
          slikano
        }
      })
    });
  });

  setTimeout(() => ucitajPodatke(), 1000);
}

ucitajPodatke();
</script>
</body>
</html>
