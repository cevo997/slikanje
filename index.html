<!DOCTYPE html>
<html lang="sr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Zakazivanje Slikanja</title>
  <style>
    /* Tvoj stil ostaje isti kao pre, radi u redu */
    body {
      font-family: Arial, sans-serif;
      background: #eef1f5;
      margin: 0;
      padding: 20px;
    }
    h1 {
      text-align: center;
      color: #333;
    }
    .selector {
      text-align: center;
      margin-bottom: 15px;
    }
    #pretragaSifre {
      width: 200px;
      padding: 8px;
      font-size: 14px;
      border-radius: 6px;
      border: 1px solid #ccc;
      margin-bottom: 15px;
      text-align: center;
      display: block;
      margin-left: auto;
      margin-right: auto;
    }
    .day {
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      padding: 15px;
      max-width: 1200px;
      margin: 0 auto;
    }
    .day h2 {
      text-align: center;
      color: #444;
      margin-bottom: 20px;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 15px;
    }
    .time-slot {
      border: 1px solid #ccc;
      padding: 10px;
      border-radius: 6px;
      background: #f9f9f9;
      transition: background 0.3s ease;
      position: relative;
    }
    .time-slot.filled {
      background: #d0f0d0;
      opacity: 0.85;
    }
    .time-slot h4 {
      margin: 0 0 5px 0;
      font-size: 14px;
      color: #222;
      text-align: center;
    }
    .time-slot input[type="text"],
    .time-slot input[type="tel"] {
      width: 100%;
      padding: 5px;
      margin-bottom: 5px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 13px;
      text-align: center;
      box-sizing: border-box;
    }
    .slikano-label {
      position: absolute;
      top: 10px;
      right: 10px;
      font-size: 13px;
      color: #333;
    }
    .slikano-label input {
      margin-right: 5px;
    }
    #rezultatiPretrage {
      text-align: center;
      margin-bottom: 10px;
      color: #555;
      font-weight: 600;
      white-space: pre-line;
    }
  </style>
</head>
<body>
  <h1>Zakazivanje Slikanja</h1>

  <input
    type="text"
    id="pretragaSifre"
    placeholder="Pretraga po šifri stana"
    oninput="pretraziSifru()"
    autocomplete="off"
  />

  <div class="selector">
    <label for="izborDatuma">Izaberi datum:</label>
    <select id="izborDatuma" onchange="promeniDatum(this.value)"></select>
  </div>

  <div id="rezultatiPretrage"></div>

  <div class="day" id="daySchedule">
    <h2>Učitavanje...</h2>
  </div>

  <script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzZiVfxttTAqr6lJFYzdma4kIa0K3HZanVYFFUxWFWLBdN00JbUzi9S4OtwUZ_eZ-yblQ/exec";

    const startHour = 9;
    const endHour = 19;
    const interval = 30; // minutes

    let savedData = {};
    let datumKey = getTodayInSerbia();

    // Debounce funkcija
    function debounce(func, wait) {
      let timeout;
      return function(...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(this, args), wait);
      };
    }

    async function fetchData(dateStr) {
      try {
        const response = await fetch(`${SCRIPT_URL}?action=getByDate&datum=${dateStr}`);
        if (!response.ok) throw new Error("Greška u mreži");
        const data = await response.json();
        savedData[dateStr] = {};
        data.forEach(item => {
          savedData[dateStr][item.Termin] = {
            sifra: item.SifraStana,
            agent: item.Agent,
            adresa: item.Adresa,
            telefon: item.Telefon,
            slikano: item.Slikano
          };
        });
        renderSchedule(dateStr);
        popuniDropdown();
        return true;
      } catch (e) {
        console.error(e);
        document.getElementById("daySchedule").innerHTML = "<h2>Greška pri učitavanju podataka</h2>";
        return false;
      }
    }

    // Save funkcija (poziva se preko debounce)
    function saveSlotImmediate(dateStr, timeStr, slotData) {
      const params = new URLSearchParams({
        action: "update",
        datum: dateStr,
        termin: timeStr,
        sifraStana: slotData.sifra || '',
        agent: slotData.agent || '',
        adresa: slotData.adresa || '',
        telefon: slotData.telefon || '',
        slikano: slotData.slikano ? 'true' : 'false'
      });

      console.log('Šaljem update za', dateStr, timeStr, slotData);

      fetch(`${SCRIPT_URL}?${params.toString()}`)
        .then(res => res.json())
        .then(result => {
          if (result.status !== "success") {
            console.error("Greška pri čuvanju:", result.message || result);
          }
        })
        .catch(e => console.error("Greška pri čuvanju:", e));
    }

    const debouncedSave = debounce(saveSlotImmediate, 500);

    function getTodayInSerbia() {
      const now = new Date();
      const offset = 2 * 60; // UTC+2h Srbija
      const local = new Date(now.getTime() + (now.getTimezoneOffset() + offset) * 60000);
      const yyyy = local.getFullYear();
      const mm = String(local.getMonth() + 1).padStart(2, '0');
      const dd = String(local.getDate()).padStart(2, '0');
      return `${yyyy}-${mm}-${dd}`;
    }

    function pad(n) {
      return n.toString().padStart(2, '0');
    }

    function renderSchedule(dateStr) {
      const container = document.getElementById("daySchedule");
      container.innerHTML = "";

      const title = document.createElement("h2");
      title.textContent = `Datum: ${dateStr.split("-").reverse().join(".")}`;
      container.appendChild(title);

      const grid = document.createElement("div");
      grid.className = "grid";

      for (let h = startHour; h <= endHour; h++) {
        for (let m = 0; m < 60; m += interval) {
          const timeStr = `${pad(h)}:${pad(m)}`;
          const slotData = savedData[dateStr]?.[timeStr] || {
            agent: "",
            adresa: "",
            telefon: "",
            sifra: "",
            slikano: false
          };

          const slotDiv = document.createElement("div");
          slotDiv.className = "time-slot";
          if (slotData.agent || slotData.adresa || slotData.telefon || slotData.sifra) {
            slotDiv.classList.add("filled");
          }

          slotDiv.id = `slot-${dateStr.replace(/-/g, "")}-${timeStr.replace(":", "")}-${slotData.sifra}`;

          const label = document.createElement("h4");
          label.textContent = timeStr;
          slotDiv.appendChild(label);

          const agentInput = document.createElement("input");
          agentInput.type = "text";
          agentInput.placeholder = "Agent";
          agentInput.value = slotData.agent;

          const adresaInput = document.createElement("input");
          adresaInput.type = "text";
          adresaInput.placeholder = "Adresa stana";
          adresaInput.value = slotData.adresa;

          const telefonInput = document.createElement("input");
          telefonInput.type = "tel";
          telefonInput.placeholder = "Kontakt telefon";
          telefonInput.value = slotData.telefon;

          const sifraInput = document.createElement("input");
          sifraInput.type = "text";
          sifraInput.placeholder = "Šifra stana";
          sifraInput.value = slotData.sifra;

          const slikanoLabel = document.createElement("label");
          slikanoLabel.className = "slikano-label";
          const slikanoCheckbox = document.createElement("input");
          slikanoCheckbox.type = "checkbox";
          slikanoCheckbox.checked = slotData.slikano;
          slikanoLabel.appendChild(slikanoCheckbox);
          slikanoLabel.appendChild(document.createTextNode("Slikano"));
          slotDiv.appendChild(slikanoLabel);

          // Save on input changes
          function onInputChange() {
            savedData[dateStr] = savedData[dateStr] || {};
            savedData[dateStr][timeStr] = {
              agent: agentInput.value,
              adresa: adresaInput.value,
              telefon: telefonInput.value,
              sifra: sifraInput.value,
              slikano: slikanoCheckbox.checked
            };
            if (
              agentInput.value || adresaInput.value || telefonInput.value || sifraInput.value
            ) {
              slotDiv.classList.add("filled");
            } else {
              slotDiv.classList.remove("filled");
            }
            debouncedSave(dateStr, timeStr, savedData[dateStr][timeStr]);
          }

          [agentInput, adresaInput, telefonInput, sifraInput].forEach(el =>
            el.addEventListener("input", onInputChange)
          );
          slikanoCheckbox.addEventListener("change", onInputChange);

          slotDiv.appendChild(agentInput);
          slotDiv.appendChild(adresaInput);
          slotDiv.appendChild(telefonInput);
          slotDiv.appendChild(sifraInput);

          grid.appendChild(slotDiv);
        }
      }
      container.appendChild(grid);
    }

    function popuniDropdown() {
      const select = document.getElementById("izborDatuma");
      select.innerHTML = "";

      const datumi = Object.keys(savedData).sort();
      if (!datumi.includes(datumKey)) datumi.push(datumKey);
      datumi.sort();

      datumi.forEach(datum => {
        const option = document.createElement("option");
        option.value = datum;
        option.textContent = datum.split("-").reverse().join(".");
        if (datum === datumKey) option.selected = true;
        select.appendChild(option);
      });
    }

    function promeniDatum(datum) {
      datumKey = datum;
      if (savedData[datum]) {
        renderSchedule(datum);
      } else {
        fetchData(datum);
      }
      document.getElementById("pretragaSifre").value = "";
      document.getElementById("rezultatiPretrage").textContent = "";
    }

    function pretraziSifru() {
      const query = document.getElementById("pretragaSifre").value.trim().toLowerCase();
      const rezDiv = document.getElementById("rezultatiPretrage");
      if (!query) {
        rezDiv.textContent = "";
        return;
      }

      let results = [];
      let firstFoundId = null;
      let firstFoundDate = null;

      Object.entries(savedData).forEach(([datum, termini]) => {
        Object.entries(termini).forEach(([vreme, podaci]) => {
          if (podaci.sifra && podaci.sifra.toLowerCase().includes(query)) {
            results.push(`- ${datum.split("-").reverse().join(".")} u ${vreme} | Šifra: ${podaci.sifra}`);

            if (!firstFoundId) {
              firstFoundId = `slot-${datum.replace(/-/g, "")}-${vreme.replace(":", "")}-${podaci.sifra}`;
              firstFoundDate = datum;
            }
          }
        });
      });

      if (results.length) {
        rezDiv.textContent = `Pronađeno ${results.length} termin(a):\n` + results.join("\n");
        if (firstFoundDate !== datumKey) {
          datumKey = firstFoundDate;
          document.getElementById("izborDatuma").value = firstFoundDate;
          renderSchedule(firstFoundDate);
          setTimeout(() => {
            const el = document.getElementById(firstFoundId);
            if (el) el.scrollIntoView({ behavior: "smooth", block: "center" });
          }, 100);
        } else {
          setTimeout(() => {
            const el = document.getElementById(firstFoundId);
            if (el) el.scrollIntoView({ behavior: "smooth", block: "center" });
          }, 100);
        }
      } else {
        rezDiv.textContent = "Nema rezultata za ovu šifru.";
      }
    }

    // Init
    fetchData(datumKey);
  </script>
</body>
</html>
